<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bo's Strategy</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7D6B5D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bo Strategy">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5968/5968263.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-master: radial-gradient(circle at 85% 5%, rgba(160, 60, 50, 0.15) 0%, transparent 45%), 
                         radial-gradient(circle at 50% 15%, #7D6B5D 0%, #4E443F 65%, #1A1817 100%);
            --accent-champagne: #D1C4BC; 
            --danger-red: #9B2C2C; 
        }
        body { background: var(--bg-master); min-height: 100vh; font-family: 'Inter', sans-serif; color: #F2EBE3; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .safe-container { max-width: 500px; margin: 0 auto; padding: 0 24px; }
        .today-label { font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em; color: rgba(255,255,255,0.4); margin-bottom: 4px; display: block; }
        .main-title { font-size: 22px; font-weight: 900; color: white; background: transparent; border: none; outline: none; width: 100%; }
        
        .date-slider { display: flex; overflow-x: auto; gap: 8px; padding: 10px 0; -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; }
        .date-slider::-webkit-scrollbar { display: none; }
        .date-item { flex-shrink: 0; text-align: center; width: 22px; transition: 0.3s; opacity: 0.15; cursor: pointer; }
        .date-item.active { opacity: 1; transform: scale(1.1); }
        .date-item .day-num { font-size: 13px; font-weight: 700; display: block; }
        .date-item.active .day-num { color: var(--accent-champagne); text-shadow: 0 0 8px rgba(209, 196, 188, 0.6); }

        .month-btn { flex-shrink: 0; width: 44px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: rgba(255,255,255,0.2); }
        .month-btn.active { border-color: var(--accent-champagne); color: var(--accent-champagne); background: rgba(255,255,255,0.12); backdrop-filter: blur(20px); }
        
        .crystal-card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.02) 45%, rgba(255,255,255,0.01) 100%);
            border-radius: 1.8rem; padding: 14px 20px; margin-bottom: 1rem; backdrop-filter: blur(40px) saturate(180%);
            border-top: 1.5px solid rgba(255, 255, 255, 0.45); border-left: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2), 0 15px 40px rgba(0, 0, 0, 0.4);
            position: relative; overflow: hidden;
        }

        @keyframes sparkWide { 0% { border-color: rgba(255,255,255,0.4); } 50% { border-color: white; box-shadow: 0 0 30px rgba(255,255,255,0.6); } 100% { border-color: rgba(255,255,255,0.4); } }
        .spark-moment { animation: sparkWide 0.8s ease-out; }
        @keyframes shimmerFull { 0% { transform: translateX(-200%) skewX(-30deg); } 100% { transform: translateX(200%) skewX(-30deg); } }
        .shimmer-moment::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent); animation: shimmerFull 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; pointer-events: none; }
        @keyframes rippleDeep { 0% { transform: scale(1); } 50% { transform: scale(1.03); filter: brightness(1.25); } 100% { transform: scale(1); } }
        .celebrate-moment { animation: rippleDeep 1.2s cubic-bezier(0.22, 1, 0.36, 1); }

        .summary-panel { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(40px); border-radius: 1.8rem; display: flex; align-items: center; padding: 18px 0; margin-bottom: 30px; border-top: 1.5px solid rgba(255, 255, 255, 0.4); }
        .bubble { width: 14px; height: 14px; border: 1.2px solid rgba(255,255,255,0.4); border-radius: 50%; cursor: pointer; transition: 0.3s; }
        .bubble.active { background: var(--accent-champagne); border-color: var(--accent-champagne); box-shadow: 0 0 15px var(--accent-champagne); }
        
        .mgmt-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 1.5rem; padding: 16px; margin-bottom: 12px; }
        .mgmt-label { font-size: 8px; font-weight: 900; color: rgba(255,255,255,0.2); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 10px; display: block; }
        .cat-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }

        .glass-nav { position: fixed; bottom: 40px; right: 5%; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(80px) saturate(180%); border: 0.8px solid rgba(255, 255, 255, 0.15); z-index: 2000; box-shadow: 0 20px 60px rgba(0,0,0,0.5); transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); height: auto; display: flex; align-items: center; will-change: width, border-radius, height; }
        .glass-nav.collapsed { width: 50px; height: 50px; background: transparent !important; border: none !important; box-shadow: none !important; backdrop-filter: none !important; justify-content: center; cursor: pointer; bottom: 45px; overflow: visible; }
        .heart-btn-box { display: none; width: 50px; height: 50px; align-items: center; justify-content: center; }
        .glass-nav.collapsed .heart-btn-box { display: flex; }
        .heart-svg-simple { width: 28px; height: 28px; color: var(--accent-champagne); filter: drop-shadow(0 0 8px rgba(209, 196, 188, 0.5)); animation: kPulseSimple 2.5s infinite ease-in-out; }
        @keyframes kPulseSimple { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        .glass-nav:not(.collapsed) { width: 90%; border-radius: 2.5rem; padding: 16px; flex-direction: column; gap: 12px; overflow: hidden; }
        .nav-content-col { display: flex; flex-direction: column; width: 100%; opacity: 1; transition: opacity 0.4s; gap: 12px; }
        .glass-nav.collapsed .nav-content-col { opacity: 0; pointer-events: none; display: none; }
        .row-top { display: flex; align-items: center; gap: 8px; width: 100%; }
        .row-bottom { display: flex; align-items: center; justify-content: space-between; width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; }
        .qty-box-k { width: 38px; height: 34px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center; font-size: 12px; font-weight: 900; color: var(--accent-champagne); border: 1px solid rgba(255,255,255,0.08); outline: none; }
        .cat-select-k { background: rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 0 6px; height: 34px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.12); }
        .add-btn-k { width: 34px; height: 34px; background: white; border-radius: 10px; color: #1a1817; font-weight: 900; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(255,255,255,0.2); }
        .type-select-full { background: transparent; font-size: 10px; font-weight: 900; color: white; opacity: 0.5; outline: none; }
        .close-x-text { font-size: 10px; color: white; opacity: 0.2; padding: 4px 8px; cursor: pointer; font-weight: 900; }
        .trash-btn { color: var(--danger-red); cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 34px; height: 34px; border-radius: 10px; transition: 0.2s; font-size: 8px; font-weight: 900; }
        .title-wrap { display: inline-flex; align-items: center; position: relative; max-width: 85%; }
        .mirror-span { font-size: 16px; font-weight: 900; visibility: hidden; white-space: pre; padding-right: 4px; }
        .task-title-input { position: absolute; left: 0; top: 0; width: 100%; background: transparent; border: none; outline: none; font-size: 16px; font-weight: 900; color: white; padding: 0; }
    </style>
</head>
<body class="pb-96 pt-10">
    <div id="noteModal" class="fixed inset-0 bg-black/85 backdrop-blur-xl z-[3000] hidden items-center justify-center p-6"><div class="note-box bg-[#2A2624] border border-white/10 rounded-[2.2rem] p-7 w-full max-w-sm"><p id="noteTargetName" class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em] mb-1"></p><h3 class="text-xl font-black text-white">ç·¨è¼¯å‚™è¨»</h3><textarea id="noteField" class="w-full bg-black/20 border border-white/10 rounded-xl p-4 text-white text-sm outline-none my-4 h-40"></textarea><div class="flex gap-3"><button onclick="closeNote()" class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black">CANCEL</button><button onclick="saveNote()" class="flex-1 py-4 rounded-xl bg-[#D1C4BC] text-[#1a1817] text-[10px] font-black">SAVE</button></div></div></div>

    <div class="safe-container">
        <header class="mb-6"><span id="topTodayDate" class="today-label"></span><div class="flex justify-between items-end gap-4"><div class="flex-1"><input type="text" id="boTitle" class="main-title" oninput="saveTitle()" placeholder="å¹´åº¦è¨ˆåŠƒä¸»é¡Œ"></div><div class="flex items-center gap-3 mb-2 shrink-0"><span class="text-[8px] font-black text-white/30 uppercase tracking-widest">å¹´åº¦é”æˆç¸½ç‡</span><span id="annualRate" class="text-[20px] font-black text-[#D1C4BC]">0%</span></div></div></header>
        <div class="date-slider no-scrollbar" id="dateSlider"></div>
        <div class="flex overflow-x-auto gap-3 mb-6 no-scrollbar" id="monthNav"></div>
        <div class="summary-panel">
            <div class="flex-1 border-r border-white/10 text-center"><p class="text-[8px] font-black text-white/30 uppercase mb-1 tracking-widest">æœ¬é€±é€²åº¦</p><p id="weekRate" class="text-[18px] font-black text-white">0%</p></div>
            <div class="flex-1 border-r border-white/10 text-center"><p class="text-[8px] font-black text-white/30 uppercase mb-1 tracking-widest">æœˆå®Œæˆç‡</p><p id="monthRate" class="text-[18px] font-black text-white">0%</p></div>
            <div class="flex-1 text-center"><p class="text-[8px] font-black text-white/30 uppercase mb-1 tracking-widest">ç€è¦½æœˆä»½</p><p id="goalDisplay" class="text-[18px] font-black text-white">2026.01</p></div>
        </div>
        <main id="taskList" class="space-y-4"></main>
        
        <details class="mt-20">
            <summary class="py-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-center gap-2 text-[10px] font-black text-white/30 uppercase tracking-widest cursor-pointer">ç­–ç•¥ç®¡ç†ä¸­å¿ƒ</summary>
            <div class="mt-6 space-y-4">
                <div class="mgmt-card"><span class="mgmt-label">ç­–ç•¥ä½ˆå±€å·¥å…·</span><button onclick="toggleMoveMode()" class="w-full py-4 rounded-xl border border-white/10 text-[10px] font-black tracking-[0.2em] transition-all bg-white/5 text-white/40">èª¿æ•´ç›®æ¨™ä½ˆå±€</button></div>
                <div class="mgmt-card"><span class="mgmt-label">é ˜åŸŸçµæ§‹ç®¡ç†</span><div id="catManagerList" class="mb-4"></div><div class="flex gap-2"><input type="text" id="newCatName" placeholder="è¼¸å…¥åç¨±..." class="flex-1 bg-white/5 outline-none text-[11px] font-bold text-white/80 border border-white/10 rounded-lg px-3 py-2 focus:border-[#D1C4BC]/50 transition-all"><button onclick="addCat()" class="text-[10px] font-black text-[#D1C4BC] px-2">ADD</button></div></div>
                <div class="mgmt-card"><span class="mgmt-label">æª”æ¡ˆåº« (å‚™æ¡ˆç®¡ç†)</span><div id="archivedTasksList" class="mb-2"></div><div id="archivedCatsList"></div></div>
                <div class="mgmt-card">
                    <span class="mgmt-label">æ•¸æ“šå‚™ä»½èˆ‡é·ç§»</span>
                    <div class="flex flex-col gap-2">
                        <button onclick="exportFullBackup()" class="w-full bg-[#D1C4BC] text-[#1a1817] text-[10px] font-black py-3 rounded-xl shadow-lg">å»ºç«‹å®Œæ•´å‚™ä»½ä»£ç¢¼ (æ›æ©Ÿç”¨)</button>
                        <button onclick="importFullBackup()" class="w-full bg-white/5 border border-white/10 text-white/50 text-[10px] font-black py-3 rounded-xl">åŒ¯å…¥å‚™ä»½æ•¸æ“š</button>
                        <button onclick="exportData()" class="w-full text-white/20 text-[8px] py-2">è¤‡è£½ç´”æ–‡å­—æ•¸æ“šé€²è¡Œ AI å¾©ç›¤</button>
                    </div>
                </div>
                <p class="text-center text-[7px] text-white/10 py-4 tracking-[0.3em]">VERSION 48.5.29 Â· PWA STABLE</p>
            </div>
        </details>

        <nav id="bottomNav" class="glass-nav collapsed" onclick="openDock()">
            <div class="heart-btn-box">
                <svg class="heart-svg-simple" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <div class="nav-content-col">
                <div class="row-top">
                    <div class="cat-select-k"><select id="catSelect" class="bg-transparent text-[10px] font-bold text-white/40 outline-none w-[58px]"></select></div>
                    <input type="text" id="taskName" class="flex-1 min-w-0 bg-transparent text-sm font-bold text-white placeholder-white/20 outline-none px-1" placeholder="æ–°å¢ç›®æ¨™..." onclick="event.stopPropagation()">
                    <input type="number" id="taskQty" class="qty-box-k" value="1" onclick="event.stopPropagation()">
                    <button onclick="addTask(event)" class="add-btn-k">ï¼‹</button>
                </div>
                <div class="row-bottom">
                    <select id="taskType" class="type-select-full">
                        <option value="daily">æ¯æ—¥åŸå­ç¿’æ…£</option>
                        <option value="weekly">æ¯é€±è¨ˆç•«</option>
                        <option value="annual">å¹´åº¦è¨ˆç•«</option>
                    </select>
                    <div onclick="closeDock(event)" class="close-x-text">âœ• CLOSE</div>
                </div>
            </div>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
        const KEY = 'bo_v48_6';
        let categories = JSON.parse(localStorage.getItem(KEY+'_cats')) || [{id:'c1', title:'æ ¸å¿ƒç›®æ¨™ CORE'}];
        let habits = JSON.parse(localStorage.getItem(KEY+'_tasks')) || [];
        let archivedCats = JSON.parse(localStorage.getItem(KEY+'_arch_cats')) || [];
        let archivedHabits = JSON.parse(localStorage.getItem(KEY+'_arch_tasks')) || [];
        let history = JSON.parse(localStorage.getItem(KEY+'_hist')) || {};
        let notes = JSON.parse(localStorage.getItem(KEY+'_notes')) || {};
        let titleVal = localStorage.getItem(KEY+'_title') || "", currentEditingTaskId = "", isMoveMode = false, newlyAchievedId = null, lastClick = 0;
        let viewingMonth = new Date().getMonth() + 1, selectedDate = new Date();
        let taskDelIdx = -1, catDelIdx = -1;

        function getDKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        }

        function init() {
            habits.forEach(h => { if(!h.id) h.id = 't_' + Math.random().toString(36).substr(2, 9); });
            document.getElementById('topTodayDate').innerText = getDKey(new Date()).replace(/-/g, '.');
            document.getElementById('boTitle').value = titleVal;
            render(); renderCatManager(); renderMonths(); renderDateSlider();
            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
        }

        function triggerSuccessFX() { confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 }, colors: ['#D1C4BC', '#ffffff'], shapes: ['circle'], scalar: 0.9 }); }
        function openDock() { document.getElementById('bottomNav').classList.remove('collapsed'); }
        function closeDock(e) { if(e) e.stopPropagation(); document.getElementById('bottomNav').classList.add('collapsed'); }

        function toggleDaily(id) { 
            const now = Date.now();
            const dK = getDKey(selectedDate);
            if(!history[dK]) history[dK] = {};
            if (now - lastClick < 300) { history[dK][id] = 0.1; newlyAchievedId = id; save(); lastClick = 0; return; }
            lastClick = now; 
            history[dK][id] = (history[dK][id] >= 1) ? 0 : 1; 
            newlyAchievedId = id; save(); 
        }

        function setWeekly(id, n) { const dK = getDKey(selectedDate); if(!history[dK]) history[dK]={}; history[dK][id] = n; newlyAchievedId = id; save(); }
        function getWeeklyDone(id) { 
            const curr = new Date(selectedDate); const day = curr.getDay(); const diff = curr.getDate() - (day === 0 ? 6 : day - 1);
            const mon = new Date(new Date(selectedDate).setDate(diff)); let t = 0;
            for(let i=0; i<7; i++){ const dK = getDKey(new Date(new Date(mon).setDate(mon.getDate() + i))); t += history[dK]?.[id] || 0; } return t;
        }
        function getAnnualDone(id) { let t = 0; Object.keys(history).forEach(k => { if(history[k]?.[id]) t += history[k][id]; }); return t; }

        function render() {
            const dK = getDKey(selectedDate), list = document.getElementById('taskList');
            list.innerHTML = '';
            document.getElementById('catSelect').innerHTML = categories.map(c => `<option value="${c.id}">${c.title}</option>`).join('');
            categories.forEach(cat => {
                let sectionHTML = `<section><div class="text-[15px] font-black text-white/70 mb-4 pl-1">${cat.title}</div>`;
                habits.filter(h => h.cid === cat.id).forEach(h => {
                    const raw = h.type === 'annual' ? getAnnualDone(h.id) : (h.type === 'daily' ? (history[dK]?.[h.id] || 0) : getWeeklyDone(h.id));
                    const rate = Math.round((raw / h.target) * 100);
                    let celClass = (h.id === newlyAchievedId) ? (rate >= 100 ? 'celebrate-moment' : (rate >= 60 ? 'shimmer-moment' : (rate >= 30 ? 'spark-moment' : ''))) : '';
                    if (newlyAchievedId === h.id) { if(rate >= 100) triggerSuccessFX(); newlyAchievedId = null; }
                    sectionHTML += `<div class="crystal-card ${celClass}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1 overflow-hidden">
                                ${h.type==='daily' ? `<div class="w-7 h-7 border-2 border-white/20 rounded-full flex items-center justify-center mr-3 daily-circle ${raw > 0 ? 'bg-[#D1C4BC] border-[#D1C4BC]' : ''}" onclick="toggleDaily('${h.id}')">
                                    ${raw >= 1 ? '<svg class="w-3.5 h-3.5 text-stone-900" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="6"><path d="M5 13l4 4L19 7"></path></svg>' : (raw > 0 ? '<div class="w-1.5 h-1.5 bg-stone-900 rounded-full"></div>' : '')}
                                </div>` : ''}
                                <div class="title-wrap"><span class="mirror-span">${h.name}</span><input type="text" class="task-title-input" value="${h.name}" onblur="renameTask('${h.id}', this.value)" oninput="this.previousElementSibling.innerText = this.value">
                                <div onclick="openNote('${h.id}')" class="note-trigger ${notes[h.id]?'active':''} opacity-20 cursor-pointer p-1 ml-0.5"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></div></div>
                            </div><div class="opacity-10 text-xs pl-4" onclick="archiveTask('${h.id}')">âœ•</div>
                        </div>
                        <div class="mt-1 ${h.type==='daily' ? 'pl-[40px]' : 'pl-0'}"><p class="text-[9px] font-black text-white/30 uppercase tracking-[0.12em]">${h.type==='daily'?'æ¯æ—¥åŸå­ç¿’æ…£':(h.type==='annual'?'å¹´åº¦è¨ˆç•«':'æ¯é€±è¨ˆç•«')}</p></div>
                        ${isMoveMode ? `<select class="w-full mt-3 bg-white/5 p-1.5 rounded-lg text-[9px] text-white/40" onchange="moveTaskToCat('${h.id}', this.value)">${categories.map(c => `<option value="${c.id}" ${c.id===h.cid?'selected':''}>${c.title}</option>`).join('')}</select>` : ''}
                        ${h.type==='weekly' ? `<div class="flex flex-wrap gap-2 mt-4">${Array.from({length: h.target}, (_,i)=>i+1).map(n => `<div class="bubble ${raw>=n?'active':''}" onclick="setWeekly('${h.id}', ${n})"></div>`).join('')}</div>` : ''}
                        ${h.type==='annual' ? `<div class="flex items-center gap-3 mt-4 bg-white/5 p-2.5 rounded-xl"><button onclick="changeAnnual('${h.id}',-1)" class="w-6 h-6">-</button><div class="flex-1 text-center font-black text-sm">${Math.floor(raw)}<span class="opacity-20 mx-1">/</span>${h.target}</div><button onclick="changeAnnual('${h.id}',1)" class="w-6 h-6">+</button></div>` : ''}
                        <div class="flex justify-between items-center mt-4 pt-3 border-t border-white/5"><div class="flex gap-3 text-[10px] font-bold text-white/30"><span>ç›®æ¨™ ${h.target}</span><span>å®Œæˆ ${Math.floor(raw)}</span><span>å‰©é¤˜ ${Math.max(0, h.target - Math.floor(raw))}</span></div><div class="text-[11px] font-black ${rate>=100?'text-[#D1C4BC]':'text-white/60'}">${rate}%</div></div>
                    </div>`;
                }); list.innerHTML += sectionHTML + `</section>`;
            }); updateSummary();
        }

        function renderCatManager() {
            const list = document.getElementById('catManagerList');
            list.innerHTML = categories.map((c, i) => `<div class="cat-row"><div class="flex items-center gap-2 flex-1"><div class="flex flex-col"><button onclick="moveCat(${i}, -1)" class="text-[7px] opacity-20">â–²</button><button onclick="moveCat(${i}, 1)" class="text-[7px] opacity-20">â–¼</button></div><input type="text" class="bg-transparent text-[11px] font-bold text-white/70 outline-none" value="${c.title}" onblur="renameCat('${c.id}', this.value)"></div><button onclick="archiveCat('${c.id}')" class="opacity-20 px-2">âœ•</button></div>`).join('');
            document.getElementById('archivedCatsList').innerHTML = archivedCats.map((c, i) => `<div class="flex justify-between items-center py-2 border-b border-white/5"><span class="text-[10px] text-white/20">${c.title}</span><div class="flex gap-4"><button onclick="restoreCat(${i})" class="text-[8px] text-[#D1C4BC]">é‚„åŸ</button><div class="trash-btn" onclick="hardDeleteCat(${i})">${catDelIdx === i ? 'SURE?' : 'ğŸ—‘ï¸'}</div></div></div>`).join('');
            document.getElementById('archivedTasksList').innerHTML = archivedHabits.map((h, i) => `<div class="flex justify-between items-center py-2 border-b border-white/5"><span class="text-[10px] text-white/20">${h.name}</span><div class="flex gap-4"><button onclick="restoreTask(${i})" class="text-[8px] text-[#D1C4BC]">é‚„åŸ</button><div class="trash-btn" onclick="hardDeleteTask(${i})">${taskDelIdx === i ? 'SURE?' : 'ğŸ—‘ï¸'}</div></div></div>`);
        }

        function save() { localStorage.setItem(KEY+'_cats', JSON.stringify(categories)); localStorage.setItem(KEY+'_tasks', JSON.stringify(habits)); localStorage.setItem(KEY+'_arch_cats', JSON.stringify(archivedCats)); localStorage.setItem(KEY+'_arch_tasks', JSON.stringify(archivedHabits)); localStorage.setItem(KEY+'_hist', JSON.stringify(history)); localStorage.setItem(KEY+'_notes', JSON.stringify(notes)); render(); }
        
        function updateSummary() {
            let tD = 0, tT = 0;
            habits.forEach(h => {
                tD += getAnnualDone(h.id);
                if (h.type === 'daily') tT += h.target * 365;
                else if (h.type === 'weekly') tT += h.target * 52;
                else tT += h.target;
            });
            document.getElementById('annualRate').innerText = tT > 0 ? Math.round((tD/tT)*100)+'%' : '0%';
            const mS = (viewingMonth).toString().padStart(2,'0'); let mD=0, mT=0;
            habits.forEach(h => { mT += (h.type === 'daily' ? h.target * 30 : (h.type === 'weekly' ? h.target * 4 : h.target / 12)); Object.keys(history).forEach(k => { if(k.includes(`2026-${mS}`)) mD += history[k][h.id] || 0; }); });
            document.getElementById('monthRate').innerText = mT > 0 ? Math.min(100, Math.round((mD/mT)*100))+'%' : '0%';
        }

        function renderDateSlider() { const s = document.getElementById('dateSlider'); s.innerHTML=''; const days = new Date(2026, viewingMonth, 0).getDate(); for(let i=1; i<=days; i++) { let d = new Date(2026, viewingMonth-1, i); const isActive = getDKey(d) === getDKey(selectedDate); s.innerHTML += `<div id="date-${i}" class="date-item ${isActive?'active':''}" onclick="selectDate('${d.toISOString()}')"><span class="day-num">${i}</span></div>`; } setTimeout(() => { const activeEl = s.querySelector('.active'); if(activeEl) activeEl.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100); }
        function selectDate(iso) { selectedDate = new Date(iso); renderDateSlider(); render(); }
        function renderMonths() { document.getElementById('monthNav').innerHTML = Array.from({length:12}, (_,i)=>i+1).map(m=>`<div class="month-btn ${m===viewingMonth?'active':''}" onclick="setMonth(${m})">${m}M</div>`).join(''); }
        function setMonth(m) { viewingMonth=m; selectedDate=new Date(2026,m-1,1); renderMonths(); renderDateSlider(); render(); document.getElementById('goalDisplay').innerText=`2026.${viewingMonth.toString().padStart(2,'0')}`; }
        function renameTask(id, v) { const h=habits.find(x=>x.id===id); if(h&&v.trim()){h.name=v.trim(); save();} }
        function renameCat(id, v) { const c=categories.find(x=>x.id===id); if(c&&v.trim()){c.title=v.trim(); save();} }
        function archiveCat(cid) { const idx = categories.findIndex(c => c.id === cid); if(idx > -1) { archivedCats.push(categories.splice(idx, 1)[0]); save(); renderCatManager(); } }
        function archiveTask(id) { const idx = habits.findIndex(h => h.id === id); if(idx > -1) { archivedHabits.push(habits.splice(idx, 1)[0]); save(); renderCatManager(); } }
        function restoreCat(i) { categories.push(archivedCats.splice(i, 1)[0]); save(); render(); renderCatManager(); }
        function restoreTask(i) { habits.push(archivedHabits.splice(i, 1)[0]); save(); render(); renderCatManager(); }
        function hardDeleteTask(i) { if(taskDelIdx === i) { archivedHabits.splice(i, 1); taskDelIdx = -1; save(); renderCatManager(); } else { taskDelIdx = i; renderCatManager(); setTimeout(() => { taskDelIdx = -1; renderCatManager(); }, 3000); } }
        function hardDeleteCat(i) { if(catDelIdx === i) { archivedCats.splice(i, 1); catDelIdx = -1; save(); renderCatManager(); } else { catDelIdx = i; renderCatManager(); setTimeout(() => { catDelIdx = -1; renderCatManager(); }, 3000); } }
        function addTask(e) { if(e) e.stopPropagation(); const n = document.getElementById('taskName').value.trim(), c = document.getElementById('catSelect').value, t = document.getElementById('taskType').value, q = parseInt(document.getElementById('taskQty').value) || 1; if(n) { habits.push({id:'t_'+Date.now(), name:n, cid:c, type:t, target:q}); save(); document.getElementById('taskName').value=''; closeDock(); } }
        function addCat() { const n = document.getElementById('newCatName').value.trim(); if(n) { categories.push({id:'c_'+Date.now(), title:n}); save(); document.getElementById('newCatName').value=''; renderCatManager(); } }
        function moveCat(i, d) { const ni = i + d; if (ni >= 0 && ni < categories.length) { [categories[i], categories[ni]] = [categories[ni], categories[i]]; save(); renderCatManager(); } }
        function changeAnnual(id, v) { const dK = getDKey(selectedDate); if(!history[dK]) history[dK]={}; history[dK][id] = Math.max(0, (history[dK][id] || 0) + v); newlyAchievedId = id; save(); }
        function toggleMoveMode() { isMoveMode = !isMoveMode; render(); }
        function saveTitle() { localStorage.setItem(KEY+'_title', document.getElementById('boTitle').value); }
        function openNote(id) { currentEditingTaskId=id; document.getElementById('noteTargetName').innerText=habits.find(h=>h.id===id)?.name||'å‚™è¨»'; document.getElementById('noteField').value=notes[id]||''; document.getElementById('noteModal').style.display='flex'; }
        function closeNote() { document.getElementById('noteModal').style.display='none'; }
        function saveNote() { notes[currentEditingTaskId]=document.getElementById('noteField').value; save(); closeNote(); }
        
        function exportFullBackup() {
            const b = { c: localStorage.getItem(KEY+'_cats'), t: localStorage.getItem(KEY+'_tasks'), h: localStorage.getItem(KEY+'_hist'), n: localStorage.getItem(KEY+'_notes'), l: localStorage.getItem(KEY+'_title') };
            const s = btoa(encodeURIComponent(JSON.stringify(b)));
            navigator.clipboard.writeText(s).then(() => alert('âœ… å‚™ä»½ç¢¼å·²è¤‡è£½ï¼'));
        }
        function importFullBackup() {
            const s = prompt("è²¼ä¸Šå‚™ä»½ç¢¼ï¼š"); if(!s) return;
            try {
                const d = JSON.parse(decodeURIComponent(atob(s)));
                localStorage.setItem(KEY+'_cats', d.c); localStorage.setItem(KEY+'_tasks', d.t); localStorage.setItem(KEY+'_hist', d.h); localStorage.setItem(KEY+'_notes', d.n); localStorage.setItem(KEY+'_title', d.l);
                location.reload();
            } catch(e) { alert("âŒ æ ¼å¼éŒ¯èª¤"); }
        }
        function exportData() { const d = {title: document.getElementById('boTitle').value, tasks: habits.map(h=>({name:h.name, rate: Math.round((getAnnualDone(h.id)/h.target)*100)+'%'}))}; navigator.clipboard.writeText(JSON.stringify(d,null,2)).then(() => alert('ğŸš€ å·²è¤‡è£½æ–‡å­—æ•¸æ“šï¼')); }
        window.onload = init;
    </script>
</body>
</html>

